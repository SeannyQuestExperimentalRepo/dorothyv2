generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── ENUMS ──────────────────────────────────────────────────────────────────

enum Sport {
  NFL
  NCAAF
  NCAAMB
  NBA
}

enum VenueType {
  OUTDOOR
  DOME
  RETRACTABLE
}

enum SpreadResult {
  COVERED
  LOST
  PUSH
}

enum OUResult {
  OVER
  UNDER
  PUSH
}

enum WeatherCategory {
  CLEAR
  CLOUDY
  RAIN
  SNOW
  WIND
  FOG
  DOME
  RETRACTABLE_CLOSED
  RETRACTABLE_OPEN
}

enum UserRole {
  FREE
  PREMIUM
  ADMIN
}

// ─── TEAM ───────────────────────────────────────────────────────────────────

model Team {
  id           Int       @id @default(autoincrement())
  name         String    // "Kansas City Chiefs"
  abbreviation String    // "KC"
  sport        Sport
  conference   String    // "AFC", "Big 12", "SEC"
  division     String?   // "West" — nullable for college
  venue        String?   // "GEHA Field at Arrowhead Stadium"
  venueType    VenueType @default(OUTDOOR)
  city         String
  state        String
  latitude     Float?    // For weather API lookups
  longitude    Float?
  createdAt    DateTime  @default(now())

  // NFL relations
  nflHomeGames NFLGame[] @relation("NFLHomeTeam")
  nflAwayGames NFLGame[] @relation("NFLAwayTeam")
  nflWins      NFLGame[] @relation("NFLWinner")

  // NCAAF relations
  ncaafHomeGames NCAAFGame[] @relation("NCAAFHomeTeam")
  ncaafAwayGames NCAAFGame[] @relation("NCAAFAwayTeam")
  ncaafWins      NCAAFGame[] @relation("NCAAFWinner")

  // NCAAMB relations
  ncaambHomeGames NCAAMBGame[] @relation("NCAAMBHomeTeam")
  ncaambAwayGames NCAAMBGame[] @relation("NCAAMBAwayTeam")
  ncaambWins      NCAAMBGame[] @relation("NCAAMBWinner")

  // NBA relations
  nbaHomeGames NBAGame[] @relation("NBAHomeTeam")
  nbaAwayGames NBAGame[] @relation("NBAAwayTeam")
  nbaWins      NBAGame[] @relation("NBAWinner")

  @@unique([sport, name])
  @@index([sport])
  @@index([sport, conference])
}

// ─── NFL GAMES ──────────────────────────────────────────────────────────────

model NFLGame {
  id              Int              @id @default(autoincrement())
  season          Int
  week            String           // "1"-"18", "WildCard", "Division", "ConfChamp", "SuperBowl"
  dayOfWeek       String           // "Sun", "Mon", "Thu", "Sat", "Fri"
  gameDate        DateTime
  kickoffTime     String?          // "8:20 PM" ET
  homeTeamId      Int
  homeTeam        Team             @relation("NFLHomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId      Int
  awayTeam        Team             @relation("NFLAwayTeam", fields: [awayTeamId], references: [id])
  homeScore       Int?
  awayScore       Int?
  scoreDifference Int?             // homeScore - awayScore (signed: positive = home win)
  winnerId        Int?
  winner          Team?            @relation("NFLWinner", fields: [winnerId], references: [id])
  isPrimetime     Boolean          @default(false)
  primetimeSlot   String?          // "MNF", "SNF", "TNF", "Saturday Primetime"
  temperature     Float?           // °F
  windMph         Float?           // Parsed numeric
  weatherCategory WeatherCategory?
  weatherRaw      String?          // Original freeform text
  spread          Float?           // Negative = home favored
  overUnder       Float?           // Total points line
  spreadResult    SpreadResult?
  ouResult        OUResult?
  isPlayoff       Boolean          @default(false)
  isNeutralSite   Boolean          @default(false)
  source          String?          // Data provenance
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([gameDate, homeTeamId, awayTeamId])
  @@index([season, week])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([gameDate])
  @@index([isPrimetime])
  @@index([spread])
  @@index([weatherCategory])
  @@index([isPlayoff])
  @@index([isPrimetime, spread])
  @@index([weatherCategory, spread])
  @@index([dayOfWeek, spread])
  @@index([isPlayoff, spread])
  @@index([season, homeTeamId, spread])
  @@index([awayTeamId, season])
}

// ─── NCAAF GAMES ────────────────────────────────────────────────────────────

model NCAAFGame {
  id               Int              @id @default(autoincrement())
  season           Int
  week             String           // "1"-"15+", "Bowl", "CFP"
  dayOfWeek        String
  gameDate         DateTime
  kickoffTime      String?
  homeTeamId       Int
  homeTeam         Team             @relation("NCAAFHomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId       Int
  awayTeam         Team             @relation("NCAAFAwayTeam", fields: [awayTeamId], references: [id])
  homeScore        Int?
  awayScore        Int?
  scoreDifference  Int?             // homeScore - awayScore (signed)
  winnerId         Int?
  winner           Team?            @relation("NCAAFWinner", fields: [winnerId], references: [id])
  homeRank         Int?             // AP ranking at game time
  awayRank         Int?
  isConferenceGame Boolean          @default(false)
  isBowlGame       Boolean          @default(false)
  bowlName         String?          // "Rose Bowl", "CFP Semifinal", etc.
  isPrimetime      Boolean          @default(false)
  primetimeSlot    String?
  temperature      Float?
  windMph          Float?
  weatherCategory  WeatherCategory?
  weatherRaw       String?
  spread           Float?           // Negative = home favored
  overUnder        Float?
  spreadResult     SpreadResult?
  ouResult         OUResult?
  homeSpOverall    Float?           // SP+ overall rating
  awaySpOverall    Float?
  homeSpOffense    Float?           // SP+ offensive rating
  awaySpOffense    Float?
  homeSpDefense    Float?           // SP+ defensive rating
  awaySpDefense    Float?
  moneylineHome    Int?
  moneylineAway    Int?
  isPlayoff        Boolean          @default(false) // CFP games
  isNeutralSite    Boolean          @default(false)
  source           String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([gameDate, homeTeamId, awayTeamId])
  @@index([season, week])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([gameDate])
  @@index([spread])
  @@index([isConferenceGame])
  @@index([isBowlGame])
  @@index([homeRank])
  @@index([awayRank])
  @@index([weatherCategory, spread])
  @@index([season, homeTeamId, spread])
  @@index([homeTeamId, season])
  @@index([awayTeamId, season])
}

// ─── NCAAMB GAMES ───────────────────────────────────────────────────────────

model NCAAMBGame {
  id               Int           @id @default(autoincrement())
  season           Int           // Year the season ends (2024 = 2023-24 season)
  gameDate         DateTime
  tipoffTime       String?
  homeTeamId       Int
  homeTeam         Team          @relation("NCAAMBHomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId       Int
  awayTeam         Team          @relation("NCAAMBAwayTeam", fields: [awayTeamId], references: [id])
  homeScore        Int?
  awayScore        Int?
  scoreDifference  Int?          // homeScore - awayScore (signed)
  winnerId         Int?
  winner           Team?         @relation("NCAAMBWinner", fields: [winnerId], references: [id])
  homeRank         Int?          // AP ranking at game time
  awayRank         Int?
  homeSeed         Int?          // NCAA tournament seed (1-16)
  awaySeed         Int?
  isConferenceGame Boolean       @default(false)
  isNeutralSite    Boolean       @default(false)
  isTournament     Boolean       @default(false) // NCAA March Madness
  tournamentRound  String?       // "First Four", "Round of 64", "Sweet 16", etc.
  tournamentRegion String?       // "East", "West", "South", "Midwest"
  isNIT            Boolean       @default(false)
  isConferenceTourney Boolean    @default(false)
  // KenPom ratings (season-level for each team)
  homeKenpomRank   Int?          // KenPom overall ranking
  awayKenpomRank   Int?
  homeAdjEM        Float?        // Adjusted efficiency margin
  awayAdjEM        Float?
  homeAdjOE        Float?        // Adjusted offensive efficiency
  awayAdjOE        Float?
  homeAdjDE        Float?        // Adjusted defensive efficiency
  awayAdjDE        Float?
  homeAdjTempo     Float?        // Adjusted tempo
  awayAdjTempo     Float?
  // FanMatch predictions (game-level)
  fmHomePred       Float?        // Predicted home score
  fmAwayPred       Float?        // Predicted away score
  fmHomeWinProb    Float?        // Home win probability (0-100)
  fmThrillScore    Float?        // KenPom thrill score
  // Betting
  spread           Float?        // Negative = home favored
  overUnder        Float?
  moneylineHome    Int?          // e.g., -150
  moneylineAway    Int?          // e.g., +130
  spreadResult     SpreadResult?
  ouResult         OUResult?
  overtimes        Int           @default(0)
  // NO weather fields — basketball is indoors
  source           String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([gameDate, homeTeamId, awayTeamId])
  @@index([season])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([gameDate])
  @@index([spread])
  @@index([isTournament])
  @@index([isTournament, tournamentRound])
  @@index([isConferenceGame])
  @@index([season, homeTeamId, spread])
  @@index([homeTeamId, season])
  @@index([awayTeamId, season])
}

// ─── NBA GAMES ─────────────────────────────────────────────────────────────

model NBAGame {
  id              Int              @id @default(autoincrement())
  season          Int              // Year the season ends (2026 = 2025-26 season)
  gameDate        DateTime
  tipoffTime      String?          // "7:30 PM" ET
  dayOfWeek       String           // "Mon", "Tue", etc.
  homeTeamId      Int
  homeTeam        Team             @relation("NBAHomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId      Int
  awayTeam        Team             @relation("NBAAwayTeam", fields: [awayTeamId], references: [id])
  homeScore       Int?
  awayScore       Int?
  scoreDifference Int?             // homeScore - awayScore (signed)
  winnerId        Int?
  winner          Team?            @relation("NBAWinner", fields: [winnerId], references: [id])
  isPrimetime     Boolean          @default(false)
  primetimeSlot   String?          // "National TV", "ESPN", "TNT"
  isPlayoff       Boolean          @default(false)
  playoffRound    String?          // "Play-In", "First Round", "Conference Semis", etc.
  isAllStar       Boolean          @default(false)
  isNeutralSite   Boolean          @default(false)
  // Betting
  spread          Float?           // Negative = home favored
  overUnder       Float?
  moneylineHome   Int?             // e.g., -150
  moneylineAway   Int?             // e.g., +130
  spreadResult    SpreadResult?
  ouResult        OUResult?
  overtimes       Int              @default(0)
  // NO weather fields — basketball is indoors
  source          String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([gameDate, homeTeamId, awayTeamId])
  @@index([season])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([gameDate])
  @@index([spread])
  @@index([isPlayoff])
  @@index([isPrimetime])
  @@index([season, homeTeamId, spread])
  @@index([homeTeamId, season])
  @@index([awayTeamId, season])
}

// ─── UPCOMING GAMES (Live odds + weather forecasts) ─────────────────────────

model UpcomingGame {
  id               Int              @id @default(autoincrement())
  sport            Sport
  gameDate         DateTime
  homeTeam         String           // Store as string for flexibility
  awayTeam         String
  homeRank         Int?             // AP ranking (1-25, null = unranked)
  awayRank         Int?
  spread           Float?           // Current consensus spread
  overUnder        Float?
  moneylineHome    Int?             // e.g., -150
  moneylineAway    Int?             // e.g., +130
  forecastTemp     Float?
  forecastWindMph  Float?
  forecastCategory WeatherCategory?
  forecastUpdated  DateTime?
  fmHomePred       Float?           // FanMatch predicted home score
  fmAwayPred       Float?           // FanMatch predicted away score
  fmHomeWinProb    Float?           // FanMatch home win probability (0-1)
  lastUpdated      DateTime         @updatedAt

  @@unique([sport, gameDate, homeTeam, awayTeam])
  @@index([sport, gameDate])
}

// ─── ODDS SNAPSHOTS (Multi-book odds from The Odds API) ─────────────────────

model OddsSnapshot {
  id            Int      @id @default(autoincrement())
  sport         Sport
  gameDate      DateTime
  homeTeam      String
  awayTeam      String
  externalId    String   // The Odds API game ID
  bookmakers    Json     // Array of ParsedOdds per bookmaker
  bestSpread    Float?   // Best available spread for home
  bestTotal     Float?   // Consensus total
  fetchedAt     DateTime @default(now())

  @@unique([externalId, fetchedAt])
  @@index([sport, gameDate])
  @@index([homeTeam, awayTeam, gameDate])
  @@index([sport, homeTeam, awayTeam, fetchedAt])
}

// ─── SAVED TRENDS ───────────────────────────────────────────────────────────

model SavedTrend {
  id              Int      @id @default(autoincrement())
  userId          String
  name            String   // User-assigned name ("Chiefs ATS home favorites")
  sport           Sport
  query           Json     // Full TrendQuery object for replay
  description     String?  // Auto-generated summary
  lastResult      Json?    // Latest trigger result snapshot
  lastTriggered   DateTime?
  notifyEmail     Boolean  @default(false)
  isPublic        Boolean  @default(false) // Visible on community leaderboard
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([sport])
  @@index([isPublic])
}

// ─── AUTH (NextAuth.js v5) ──────────────────────────────────────────────────

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  name               String?
  image              String?
  password           String?
  role               UserRole  @default(FREE)
  stripeCustomerId   String?   @unique // Stripe customer ID for billing
  subscriptionId     String?   // Stripe subscription ID
  subscriptionStatus String?   // "active", "canceled", "past_due", etc.
  emailVerified      DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  accounts           Account[]
  sessions           Session[]
  searches           SearchLog[]
  bets               Bet[]
  savedTrends        SavedTrend[]
  pushSubscriptions  PushSubscription[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── SEARCH LOGGING ─────────────────────────────────────────────────────────

model SearchLog {
  id        Int      @id @default(autoincrement())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  query     String   // Raw natural language query
  sport     Sport?
  filters   String?  // JSON of interpreted filters
  results   Int      // Number of results returned
  durationMs Int?    // Query execution time
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ─── PLAYER GAME LOGS ──────────────────────────────────────────────────────

model PlayerGameLog {
  id              Int       @id @default(autoincrement())
  playerId        String    // nflverse player ID
  playerName      String    // display name
  position        String    // "QB", "WR", etc.
  positionGroup   String    // "QB", "RB", "WR", "TE", "K", "DL", "LB", "DB", "OL"
  season          Int
  week            Int
  seasonType      String    @default("REG")  // "REG" | "POST"
  team            String    // abbreviation ("KC")
  opponentTeam    String    // abbreviation ("BUF")
  gameDate        DateTime?
  isHome          Boolean?
  teamScore       Int?
  opponentScore   Int?
  gameResult      String?   // "W" | "L" | "T"
  spread          Float?
  overUnder       Float?
  spreadResult    String?   // "COVERED" | "LOST" | "PUSH"
  ouResult        String?   // "OVER" | "UNDER" | "PUSH"
  isPlayoff       Boolean   @default(false)
  isPrimetime     Boolean?
  stats           Json      @default("{}")  // All stat fields + metadata as JSONB

  @@index([playerId, season])
  @@index([playerName])
  @@index([team, season])
  @@index([season, positionGroup])
  @@index([playerId])
}

// ─── BET TRACKING ──────────────────────────────────────────────────────────

enum BetType {
  SPREAD
  OVER_UNDER
  MONEYLINE
  PLAYER_PROP
  PARLAY
  TEASER
}

enum BetResult {
  WIN
  LOSS
  PUSH
  PENDING
}

model Bet {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  sport       Sport
  betType     BetType
  gameDate    DateTime
  homeTeam    String
  awayTeam    String
  pickSide    String    // "home", "away", "over", "under", player name for props
  line        Float?    // spread/total line
  oddsValue   Int       @default(-110) // American odds: -110, +150, etc.
  stake       Float     // amount wagered
  toWin       Float     // amount to win (calculated from odds)
  result      BetResult @default(PENDING)
  profit      Float?    // + for win, - for loss, 0 for push (calculated on grading)
  sportsbook  String?   // "DraftKings", "FanDuel", etc.
  playerName  String?   // for PLAYER_PROP bets
  propStat    String?   // "passing_yards", "rushing_yards", etc.
  propLine    Float?    // prop-specific line
  notes       String?   // user notes
  parlayLegs  Json?     // for PARLAY/TEASER: [{homeTeam, awayTeam, pickSide, line}]
  teaserPoints Float?   // for TEASER: points added (e.g., 6)
  dailyPickId Int?      // link to DailyPick if bet originated from a pick
  gradedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([userId, result])
  @@index([userId, sport])
  @@index([userId, gameDate])
  @@index([userId, createdAt])
  @@index([gameDate, homeTeam, awayTeam])
  @@index([result])
}

// ─── DAILY PICKS ─────────────────────────────────────────────────────────

model DailyPick {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  sport       Sport
  pickType    String   // SPREAD, OVER_UNDER, PLAYER_PROP
  homeTeam    String
  awayTeam    String
  gameDate    DateTime
  pickSide    String   // home, away, over, under
  line        Float?
  pickLabel   String   // "Chiefs -7" or "Over 48.5" or "Mahomes Over 275.5 Pass Yds"
  playerName  String?
  propStat    String?
  propLine    Float?
  trendScore  Int      // 0-100
  confidence  Int      // 3, 4, or 5
  headline    String
  reasoning   Json     // [{angle, weight, strength, record}]
  homeRank    Int?
  awayRank    Int?
  result      String   @default("PENDING") // WIN, LOSS, PUSH, PENDING
  actualValue Float?
  gradedAt    DateTime?
  createdAt   DateTime @default(now())

  @@unique([date, sport, homeTeam, awayTeam, pickType, pickSide, playerName])
  @@index([date, sport])
  @@index([result])
  @@index([result, gradedAt])
}

// ─── PUSH NOTIFICATIONS ─────────────────────────────────────────────────────

model PushSubscription {
  id        Int      @id @default(autoincrement())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String   // Public key
  auth      String   // Auth secret
  createdAt DateTime @default(now())

  @@index([userId])
}

// ─── KENPOM DAILY SNAPSHOTS ─────────────────────────────────────────────────

model KenpomSnapshot {
  id           Int      @id @default(autoincrement())
  snapshotDate DateTime // The date this rating snapshot is from
  season       Int      // KenPom season (ending year)
  teamName     String   // KenPom team name (e.g. "Michigan St.")
  adjEM        Float
  adjOE        Float
  adjDE        Float
  adjTempo     Float
  rankAdjEM    Int
  confShort    String
  createdAt    DateTime @default(now())

  @@unique([snapshotDate, teamName])
  @@index([season])
  @@index([snapshotDate])
  @@index([teamName])
}
